---
type GalleryImage = {
  src: string;
  alt?: string;
  caption?: string;
};

const {
  images = [],
  cols = 3,
}: {
  images?: GalleryImage[];
  cols?: number;
} = Astro.props;

// Unique per component instance (build-time)
const galleryId = `glb-${Math.random().toString(36).slice(2, 10)}`;
const dialogId = `dlg-${galleryId}`;
---

<div class="gallery" style={`--cols:${cols};`} data-gallery-id={galleryId} data-total={images.length}>
  <div class="gallery-grid">
    {images.map((img, i) => (
      <button
        class="thumb"
        type="button"
        data-index={i}
        aria-label={`Open image ${i + 1} of ${images.length}`}
      >
        <img
          class="thumb-bg"
          src={img.src}
          alt=""
          aria-hidden="true"
          loading="lazy"
        />
        <img
          class="thumb-img"
          src={img.src}
          alt={img.alt ?? ""}
          loading="lazy"
        />
      </button>
    ))}
  </div>

  <div class="gallery-actions">
    <button class="gallery-toggle" type="button" aria-expanded="false"></button>
  </div>

  <dialog class="lightbox" id={dialogId} aria-label="Image viewer">
    <button class="close" type="button" aria-label="Close">×</button>

    <button class="nav prev" type="button" aria-label="Previous image">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path
          d="M15 18l-6-6 6-6"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </button>

    <button class="nav next" type="button" aria-label="Next image">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path
          d="M9 6l6 6-6 6"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </button>

    <img class="lb-image" src="" alt="" />
    <p class="caption" hidden></p>
  </dialog>

  <script is:inline define:vars={{ galleryId, dialogId, images }}>
    (function () {
      const root = document.querySelector(`[data-gallery-id="${galleryId}"]`);
      if (!root || !Array.isArray(images) || images.length === 0) return;

      const grid = root.querySelector(".gallery-grid");
      const toggle = root.querySelector(".gallery-toggle");
      const thumbs = Array.from(root.querySelectorAll(".thumb"));
      const total = thumbs.length;

      // initial: desktop=6 (2 rows @ 3 cols), mobile=5 (single column)
      const mq = window.matchMedia("(max-width: 560px)");
      const initialCount = mq.matches ? 5 : 6;

      // If not enough images, hide toggle completely
      if (total <= initialCount) {
        root.classList.remove("is-collapsed");
        root.classList.remove("has-fade");
        toggle?.remove();
      } else {
        // start collapsed
        root.classList.add("is-collapsed");
        root.classList.add("has-fade");
      }

      // Remember the gallery top for "scroll back on collapse"
      const galleryTopY = () => root.getBoundingClientRect().top + window.scrollY;

      function setThumbVisibility(expanded) {
        thumbs.forEach((btn, idx) => {
          const shouldShow = expanded || idx < initialCount;
          btn.toggleAttribute("hidden", !shouldShow);
        });
      }

      function updateToggle(expanded) {
        if (!toggle) return;
        toggle.setAttribute("aria-expanded", expanded ? "true" : "false");

        if (expanded) {
          toggle.textContent = "Zwiń";
        } else {
          const remaining = total - initialCount;
          toggle.textContent = `Pokaż pozostałe ${remaining}`;
        }
      }

      // init state
      let expanded = false;
      setThumbVisibility(false);
      updateToggle(false);

      // Toggle expand/collapse
      toggle?.addEventListener("click", () => {
        const y = galleryTopY();

        expanded = !expanded;

        if (expanded) {
          root.classList.remove("is-collapsed");
          root.classList.remove("has-fade");
          setThumbVisibility(true);
          updateToggle(true);
        } else {
          root.classList.add("is-collapsed");
          root.classList.add("has-fade");
          setThumbVisibility(false);
          updateToggle(false);

          // Scroll back to gallery position so user doesn't "get lost"
          window.scrollTo({ top: y - 12, left: 0, behavior: "smooth" });
        }
      });

      // Lightbox
      const dialog = document.getElementById(dialogId);
      if (!dialog) return;

      const imgEl = dialog.querySelector(".lb-image");
      const captionEl = dialog.querySelector(".caption");
      const btnClose = dialog.querySelector(".close");
      const btnPrev = dialog.querySelector(".prev");
      const btnNext = dialog.querySelector(".next");

      let index = 0;

      function render(i) {
        index = (i + images.length) % images.length;
        const it = images[index];

        imgEl.src = it.src;
        imgEl.alt = it.alt || "";

        if (it.caption) {
          captionEl.textContent = it.caption;
          captionEl.hidden = false;
        } else {
          captionEl.textContent = "";
          captionEl.hidden = true;
        }
      }

      function openAt(i) {
        render(i);
        try { dialog.showModal(); } catch (_) {}
        btnClose?.focus({ preventScroll: true });
      }

      function prev() { render(index - 1); }
      function next() { render(index + 1); }

      // Thumb click → open (even hidden thumbs remain in DOM with hidden attr toggled)
      thumbs.forEach((btn) => {
        btn.addEventListener("click", () => {
          const i = Number(btn.dataset.index || 0);
          openAt(i);
        });
      });

      btnClose?.addEventListener("click", () => dialog.close());
      btnPrev?.addEventListener("click", prev);
      btnNext?.addEventListener("click", next);

      document.addEventListener("keydown", (e) => {
        if (!dialog.open) return;

        if (e.key === "ArrowLeft") { e.preventDefault(); prev(); }
        else if (e.key === "ArrowRight") { e.preventDefault(); next(); }
      });

      dialog.addEventListener("click", (e) => {
        if (e.target === dialog) dialog.close();
      });
    })();
  </script>
</div>